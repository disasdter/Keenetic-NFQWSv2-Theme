<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Keenetic NFQWS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="icon.png" sizes="192x192">
    <link rel="manifest" href="manifest.json">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <meta name="MobileOptimized" content="320">
    <meta name="HandheldFriendly" content="true">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0f172a">
    <meta name="color-scheme" content="light dark">

    <!-- CodeMirror для подсветки синтаксиса -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/display/fullscreen.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/shell/shell.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/display/fullscreen.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>

    <!-- CSS файлы -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/utilities.css">
    <link rel="stylesheet" href="tln.min.css?v=v2.10.8">

    <script defer src="tln.min.js?v=v2.10.8"></script>
</head>
<body class="unknown">
<script>
    // Инициализация темы и языка
    const theme = localStorage.getItem('theme') || 'light';
    const lang = localStorage.getItem('lang') || 'en';
    
    const root = document.querySelector(':root');
    root.dataset.theme = theme;
    
    document.documentElement.lang = lang;
    
    // Сразу убираем disabled класс для предотвращения overlay
    document.body.classList.remove('disabled');
    
    // Проверяем наличие активной сессии
    const hasSession = localStorage.getItem('hasSession') === 'true';
    if (hasSession) {
        document.body.classList.add('authenticated');
    }
    
    // Функция для получения и установки версии
    async function initVersion() {
        try {
            const response = await fetch('index.php', {
                method: 'POST',
                body: new URLSearchParams({cmd: 'getversion'}),
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.status === 0) {
                    let versionText = 'vunknown';
                    if (data.version) {
                        versionText = `v${data.version}`;
                    }
                    document.getElementById('version').textContent = versionText;
                    
                    // Устанавливаем заголовок
                    const title = data.nfqws2 ? 'Keenetic NFQWS 2' : 'Keenetic NFQWS';
                    const logoElement = document.querySelector('.logo');
                    logoElement.innerHTML = `<span id="nfqws">${title}</span> <span id="status"></span>`;
                } else {
                    document.getElementById('version').textContent = 'vunknown';
                }
            } else {
                document.getElementById('version').textContent = 'vunknown';
            }
        } catch (error) {
            document.getElementById('version').textContent = 'vunknown';
        }
    }
    
    // Инициализируем версию при загрузке страницы
    document.addEventListener('DOMContentLoaded', initVersion);
</script>

<header>
    <h1 class="logo">
        <span id="nfqws">Keenetic NFQWS</span> <span id="status"></span>
    </h1>
    <div class="header-controls">
        <!-- Кнопка Save - скрыта по умолчанию, показывается при изменении -->
        <button class="button red save-icon" id="save" style="display: none;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            <span class="save-text" id="save-text">Save</span>
        </button>
        
        <!-- Кнопка создания нового файла -->
        <button class="button create-file-icon" id="create-file">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <span class="create-file-text" id="create-file-text">New File</span>
        </button>
        
        <button class="button restart-icon" id="restart">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 4v6h6"></path>
                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
            </svg>
            <span class="restart-text" id="restart-text">Restart</span>
        </button>
        
        <!-- Dropdown меню -->
        <div class="dropdown-container">
            <button class="button" id="dropdown">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </button>
            <ul id="dropdown-menu" class="dropdown-menu hidden">
                <li class="dropdown-item" id="reload">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6"></path>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                    <span id="reload-text">Reload</span>
                </li>
                <li class="dropdown-item" id="stop">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    </svg>
                    <span id="stop-text">Stop</span>
                </li>
                <li class="dropdown-item" id="start">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    <span id="start-text">Start</span>
                </li>
                <li class="dropdown-item" id="upgrade">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="16 3 21 3 21 8"></polyline>
                        <line x1="4" y1="20" x2="21" y2="3"></line>
                        <polyline points="21 16 21 21 16 21"></polyline>
                        <line x1="15" y1="15" x2="21" y2="21"></line>
                        <line x1="4" y1="4" x2="9" y2="9"></line>
                    </svg>
                    <span id="update-text">Update</span>
                </li>
            </ul>
        </div>
    </div>
</header>

<nav></nav>

<article>
    <div class="editor-container">
        <div class="editor-toolbar">
            <span class="filename" id="current-filename">No file selected</span>
            <div class="editor-actions">
                <!-- Кнопка проверки доступности - добавляем data-type для фильтрации -->
                <button class="button" id="check-availability" data-type="list-only" style="display: none;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    <span id="check-availability-text">Check Availability</span>
                </button>
                
                <button class="button" id="save-fullscreen">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    <span id="save-fs-text">Save</span>
                </button>
                <button class="icon-button" id="editor-fullscreen" title="Fullscreen">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="textarea-container">
            <textarea id="config" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
        </div>
    </div>
</article>

<footer>
    <div class="footer-left">
        <a class="footer-tab" href="https://github.com/nfqws/nfqws-keenetic/" target="_blank">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
            </svg>
            NFQWS 2
        </a>
		
		 <a class="footer-tab" href="https://github.com/disasdter/Keenetic-NFQWSv2-Theme" target="_blank">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
            </svg>
            THEME 2
        </a>
    </div>
    
    <div class="footer-right">
        <!-- Language switcher -->
        <div class="language-switcher footer-tab" id="language-switcher" title="Switch language">
            <span class="language-option" data-lang="en">EN</span>
            <span class="language-separator">|</span>
            <span class="language-option" data-lang="ru">RU</span>
        </div>
        
        <!-- Theme switcher -->
        <span id="theme" class="footer-tab theme-switcher" title="Change theme">
            <svg class="theme-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
        </span>
        
        <!-- Logout -->
        <span id="logout" class="footer-tab" title="Logout">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
        </span>
        
        <!-- Version -->
        <span id="version" class="footer-version">vunknown</span>
    </div>
</footer>

<div id="overlay"></div>

<!-- Попап для создания нового файла -->
<div id="create-file-popup" class="popup hidden">
    <div class="popup-header">
        <span class="popup-title" id="create-file-title">Create New File</span>
        <button class="popup-close-btn" title="Close">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>
    <div class="popup-content">
        <div class="create-file-form">
            <div class="form-group">
                <label for="new-filename" id="filename-label">File name (without extension)</label>
                <input type="text" id="new-filename" class="form-input" placeholder="my-config" autocomplete="off">
                <div class="form-hint" id="filename-hint">Enter file name without extension</div>
            </div>
            <div class="form-group">
                <label id="extension-label">File type</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="filetype" value=".list" checked>
                        <span class="radio-custom"></span>
                        <span class="radio-text">.list file</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="filetype" value=".conf">
                        <span class="radio-custom"></span>
                        <span class="radio-text">.conf file</span>
                    </label>
                </div>
            </div>
        </div>
    </div>
    <div class="popup-footer">
        <button class="popup-close" id="create-file-cancel">Cancel</button>
        <button class="popup-yes" id="create-file-confirm">Create</button>
    </div>
</div>

<div id="alert" class="popup hidden">
    <div class="popup-header">
        <span class="popup-title" id="popup-title"></span>
        <button class="popup-close-btn" title="Close">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>
    <pre class="popup-content" id="popup-content"></pre>
    <div class="popup-footer">
        <button class="popup-yes" id="popup-yes">Yes</button>
        <button class="popup-no" id="popup-no">No</button>
        <button class="popup-close" id="popup-close">Close</button>
    </div>
</div>

<!-- Попап для результатов проверки доступности -->
<div id="availability-results" class="popup hidden">
    <div class="popup-header">
        <span class="popup-title" id="availability-title">Domain Availability Check</span>
        <button class="popup-close-btn" title="Close">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>
    <div class="popup-content">
        <div class="availability-info">
            <div class="info-row">
                <span class="info-label">Total domains:</span>
                <span class="info-value" id="total-domains">0</span>
            </div>
            <div class="info-row">
                <span class="info-label">Accessible:</span>
                <span class="info-value accessible" id="accessible-domains">0</span>
            </div>
            <div class="info-row">
                <span class="info-label">Blocked:</span>
                <span class="info-value blocked" id="blocked-domains">0</span>
            </div>
            <div class="info-row">
                <span class="info-label">Progress:</span>
                <span class="info-value" id="progress">0%</span>
            </div>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="results-container" id="results-container"></div>
    </div>
    <div class="popup-footer">
        <button class="popup-yes" id="availability-start">Start Check</button>
        <button class="popup-close" id="availability-close">Close</button>
    </div>
</div>

<div id="login-form" class="popup hidden">
    <div class="popup-header">
        <span class="popup-title" id="login-title">Login</span>
        <button class="popup-close-btn" title="Close">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>
    <div class="popup-content">
        <input type="text" class="login-input" id="login" autocomplete="false" autofocus placeholder="Login" />
        <input autocomplete="off" type="password" class="login-input" id="password" placeholder="Password" />
    </div>
    <div class="popup-footer">
        <button class="popup-yes" id="login-button">Login</button>
    </div>
</div>

<!-- Подключаем JS файлы -->
<script defer src="js/helpers.js"></script>
<script defer src="js/drag-drop.js"></script>
<script defer src="js/dom-checker.js"></script>
<script defer src="js/ui.js"></script>

</body>
</html>